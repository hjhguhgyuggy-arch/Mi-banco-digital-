import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  collection, 
  onSnapshot, 
  addDoc, 
  serverTimestamp 
} from 'firebase/firestore';
import { 
  CreditCard, Send, PlusCircle, User, ShieldCheck, Wallet, LayoutDashboard, LogOut, 
  ArrowRightLeft, History, Eye, EyeOff, Lock, Unlock, AlertCircle, CheckCircle2, 
  Clock, Upload, Loader2, Building2, Plus, Bell, ArrowUpRight, ArrowDownLeft,
  Smartphone, Banknote, Home, Bot, RefreshCw, SmartphoneIcon, ChevronRight,
  Info, ShieldAlert, Camera, Globe, Calendar, FileText, Phone, Calculator, Landmark,
  Copy, Check, ArrowRight
} from 'lucide-react';

// --- CONFIGURACIÓN DE INFRAESTRUCTURA (Firebase) ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'neobank-master-final';

// --- COMPONENTE PRINCIPAL ---
export default function App() {
  const [view, setView] = useState('auth'); 
  const [isLogin, setIsLogin] = useState(true);
  const [isValidating, setIsValidating] = useState(false);
  const [validationTimer, setValidationTimer] = useState(25);
  const [currentUser, setCurrentUser] = useState(null);
  const [userData, setUserData] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [userAccounts, setUserAccounts] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [tempRegData, setTempRegData] = useState(null);

  // Inicialización de Autenticación (Regla 3)
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) setCurrentUser(user);
    });
    return () => unsubscribe();
  }, []);

  // Sincronización de Datos en Tiempo Real (Regla 1 y 2)
  useEffect(() => {
    if (!currentUser) return;
    
    // Perfil Principal
    const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
    const unsubscribeProfile = onSnapshot(profileRef, (docSnap) => {
      if (docSnap.exists()) setUserData(docSnap.data());
      else {
        const init = { name: 'Usuario', balance: 5, hasCard: false, activeLoan: false, verificationStatus: 'pending_upload', cardActive: true };
        setDoc(profileRef, init);
        setUserData(init);
      }
    });

    // Cuentas de Divisas
    const accountsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'accounts');
    const unsubscribeAccounts = onSnapshot(accountsRef, (snapshot) => {
      setUserAccounts(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
    });

    // Historial de Transacciones
    const transRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');
    const unsubscribeTrans = onSnapshot(transRef, (snapshot) => {
      const list = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      setTransactions(list.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
    });

    return () => { unsubscribeProfile(); unsubscribeAccounts(); unsubscribeTrans(); };
  }, [currentUser]);

  // Gestor de Notificaciones y Actividad Cloud
  const addActivity = async (title, amount = null) => {
    if (!currentUser || !userData) return;
    const ts = Date.now();
    setNotifications(prev => [...prev, { id: ts, msg: title }]);
    setTimeout(() => setNotifications(prev => prev.filter(n => n.id !== ts)), 4500);

    if (amount !== null) {
      await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), {
        title, amount: Math.abs(amount), type: amount > 0 ? 'income' : 'expense',
        createdAt: serverTimestamp(), dateLabel: new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'short' })
      });
      await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), { balance: userData.balance + amount }, { merge: true });
    }
  };

  // --- FLUJOS DE ACCESO ---
  const handleAuth = async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    if (isLogin) {
      const email = fd.get('email');
      const pass = fd.get('password');
      if (!email || !pass) return alert("Rellene todos los campos.");
      const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'auth', email.replace(/\./g, '_')));
      if (snap.exists() && snap.data().password === pass) setView('dashboard');
      else alert("Credenciales incorrectas.");
    } else {
      const data = { 
        name: fd.get('name'), dob: fd.get('dob'), docId: fd.get('docId'), 
        country: fd.get('country'), phone: fd.get('phone'), email: fd.get('email'), password: fd.get('password') 
      };
      if (Object.values(data).some(v => !v)) return alert("Debe completar todos los campos del registro.");
      setTempRegData(data); setIsValidating(true);
    }
  };

  useEffect(() => {
    let t; if (isValidating && validationTimer > 0) t = setInterval(() => setValidationTimer(v => v - 1), 1000);
    else if (isValidating && validationTimer === 0) {
      (async () => {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'auth', tempRegData.email.replace(/\./g, '_')), { uid: currentUser.uid, password: tempRegData.password, name: tempRegData.name });
        await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main'), { ...tempRegData, balance: 5, hasCard: false, activeLoan: false, verificationStatus: 'pending_upload', cardActive: true }, { merge: true });
        setIsValidating(false); setView('dashboard'); addActivity("Bóveda Cloud activada.");
      })();
    }
    return () => clearInterval(t);
  }, [isValidating, validationTimer]);

  const renderView = () => {
    if (!userData && view !== 'auth') return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-indigo-600" /></div>;
    switch (view) {
      case 'dashboard': return <Dashboard user={userData} transactions={transactions} setView={setView} accounts={userAccounts} />;
      case 'transfer': return <TransferView addActivity={addActivity} setView={setView} />;
      case 'addFunds': return <AddFundsView addActivity={addActivity} />;
      case 'profile': return <ProfileView user={userData} setView={setView} uid={currentUser.uid} />;
      case 'verify': return <VerificationProcess setView={setView} addActivity={addActivity} uid={currentUser.uid} />;
      case 'cards': return <CardsView user={userData} addActivity={addActivity} uid={currentUser.uid} />;
      case 'loan': return <LoanView user={userData} setView={setView} addActivity={addActivity} uid={currentUser.uid} />;
      case 'currencies': return <CurrenciesView accounts={userAccounts} uid={currentUser.uid} addActivity={addActivity} />;
      default: return <Dashboard user={userData} transactions={transactions} setView={setView} accounts={userAccounts} />;
    }
  };

  if (view === 'auth') {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
        <div className={`bg-white p-8 md:p-12 rounded-[3.5rem] shadow-2xl w-full ${isLogin ? 'max-w-md' : 'max-w-2xl'} relative overflow-hidden border border-slate-100 transition-all duration-500`}>
          {isValidating && (
             <div className="absolute inset-0 bg-white/98 z-50 flex flex-col items-center justify-center p-10 text-center animate-in fade-in">
                <Loader2 className="w-16 h-16 text-indigo-600 animate-spin mb-6" />
                <h2 className="text-2xl font-black text-slate-900 mb-2 uppercase tracking-tighter">Validando Cuenta</h2>
                <p className="text-slate-400 text-sm mb-10">Conectando con servidores centrales... {validationTimer}s</p>
                <div className="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden"><div className="bg-indigo-600 h-full transition-all duration-1000 ease-linear" style={{ width: `${((25 - validationTimer) / 25) * 100}%` }}></div></div>
             </div>
          )}
          <div className="flex flex-col items-center mb-10 text-center">
            <div className="bg-indigo-600 p-4 rounded-2xl mb-4 shadow-xl"><Wallet className="text-white w-8 h-8" /></div>
            <h1 className="text-3xl font-black tracking-tighter uppercase text-lg">NeoBank</h1>
            <p className="text-slate-400 font-bold text-[9px] uppercase tracking-widest mt-1">Global Cloud Identity</p>
          </div>
          <form onSubmit={handleAuth} className="space-y-4">
            {isLogin ? (
              <div className="space-y-4">
                <Input label="Correo Electrónico" name="email" type="email" placeholder="ejemplo@correo.com" required />
                <Input label="Contraseña" name="password" type="password" placeholder="••••••••" required />
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Input label="Nombre Completo" name="name" icon={<User size={14}/>} required />
                <Input label="Nacimiento" name="dob" type="date" icon={<Calendar size={14}/>} required />
                <Input label="Nº Documento" name="docId" icon={<FileText size={14}/>} required />
                <Input label="País Residencia" name="country" icon={<Globe size={14}/>} required />
                <Input label="Teléfono" name="phone" type="tel" icon={<Phone size={14}/>} required />
                <Input label="Email" name="email" type="email" icon={<Bell size={14}/>} required />
                <div className="md:col-span-2"><Input label="Crear Contraseña" name="password" type="password" required /></div>
              </div>
            )}
            <button className="w-full bg-indigo-600 hover:bg-indigo-700 text-white p-5 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl mt-6 transition-all">{isLogin ? 'Iniciar Sesión' : 'Activar Bóveda'}</button>
          </form>
          <button onClick={() => setIsLogin(!isLogin)} className="w-full text-indigo-600 mt-8 text-[9px] font-black uppercase tracking-[0.2em] hover:underline">{isLogin ? '¿Abrir una cuenta nueva?' : '¿Ya tienes acceso? Entra'}</button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row font-sans text-slate-900">
      <nav className="fixed bottom-0 left-0 right-0 bg-white border-t md:relative md:w-72 md:border-t-0 md:border-r flex md:flex-col p-4 z-50 md:min-h-screen">
        <div className="hidden md:flex flex-col items-center mb-12 mt-6">
          <div className="bg-indigo-600 p-3 rounded-2xl mb-3"><Wallet className="text-white w-6 h-6" /></div>
          <span className="font-black text-xl tracking-tighter uppercase text-xs tracking-widest">NeoBank Elite</span>
        </div>
        <div className="flex md:flex-col justify-around w-full md:space-y-2">
          <NavItem active={view === 'dashboard'} icon={<LayoutDashboard size={22}/>} label="Portal" onClick={() => setView('dashboard')} />
          <NavItem active={view === 'currencies'} icon={<Globe size={22}/>} label="Divisas" onClick={() => setView('currencies')} />
          <NavItem active={view === 'transfer'} icon={<Send size={22}/>} label="Enviar" onClick={() => setView('transfer')} />
          <NavItem active={view === 'addFunds'} icon={<PlusCircle size={22}/>} label="Ingresar" onClick={() => setView('addFunds')} />
          <NavItem active={view === 'cards'} icon={<CreditCard size={22}/>} label="Tarjetas" onClick={() => setView('cards')} />
          <NavItem active={view === 'loan'} icon={<History size={22}/>} label="Préstamos" onClick={() => setView('loan')} />
          <NavItem active={view === 'profile'} icon={<User size={22}/>} label="Ajustes" onClick={() => setView('profile')} />
          <button onClick={() => setView('auth')} className="hidden md:flex items-center space-x-3 p-4 text-rose-500 font-black text-[10px] uppercase tracking-widest mt-12 hover:bg-rose-50 rounded-2xl transition"><LogOut size={20}/><span>Cerrar</span></button>
        </div>
      </nav>

      <main className="flex-1 overflow-y-auto pb-32 md:pb-12 bg-slate-50/50">
        <header className="bg-white/80 backdrop-blur-md border-b p-5 sticky top-0 z-40 flex justify-between items-center px-6 md:px-10">
          <h2 className="font-black text-slate-800 text-[10px] tracking-[0.2em] uppercase">Panel General</h2>
          <div className="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-black shadow-lg border-2 border-white uppercase">{userData?.name?.charAt(0)}</div>
        </header>
        <div className="max-w-5xl mx-auto p-5 md:p-10">{renderView()}</div>
      </main>

      <div className="fixed top-24 right-4 flex flex-col space-y-3 z-[60]">
        {notifications.map((n) => (
          <div key={n.id} className="bg-slate-900 text-white px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-4 animate-in slide-in-from-right border-l-4 border-indigo-500 min-w-[300px]">
            <Bell size={18} className="text-indigo-400" /><p className="text-[10px] font-black uppercase tracking-widest">{n.msg}</p>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- SHARED UI ---
function NavItem({ active, icon, label, onClick }) {
  return (
    <button onClick={onClick} className={`flex flex-col md:flex-row items-center space-y-1 md:space-y-0 md:space-x-4 p-2 md:px-5 md:py-4 rounded-2xl transition-all duration-300 ${active ? 'text-indigo-600 bg-indigo-50 font-black shadow-sm border border-indigo-100' : 'text-slate-400 hover:text-indigo-600 hover:bg-slate-50'}`}>
      {icon} <span className="text-[10px] md:text-[13px] tracking-tight">{label}</span>
    </button>
  );
}

function Input({ label, icon, ...props }) {
  return (
    <div className="flex flex-col gap-1.5 w-full">
      <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1 flex items-center gap-1.5">{icon} {label}</label>
      <input {...props} className="w-full p-4 rounded-2xl border border-slate-100 focus:ring-4 focus:ring-indigo-50 outline-none transition-all text-sm bg-white placeholder:text-slate-200" />
    </div>
  );
}

// --- DASHBOARD ---
function Dashboard({ user, transactions, setView, accounts }) {
  return (
    <div className="space-y-8 animate-in fade-in duration-700">
      <div className="bg-white p-8 md:p-10 rounded-[3rem] border border-slate-100 shadow-xl shadow-slate-200/50 flex flex-col items-center text-center relative overflow-hidden group">
         <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-indigo-500 to-indigo-800"></div>
         <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">Saldo Consolidado</p>
         <h3 className="text-7xl font-black text-slate-900 tracking-tighter flex items-start gap-2">
            <span className="text-3xl font-light text-slate-300 mt-2">$</span>
            {user?.balance?.toLocaleString()}
         </h3>
         
         <div className="grid grid-cols-3 gap-6 md:gap-12 mt-12 w-full max-w-sm">
            <button onClick={() => setView('transfer')} className="flex flex-col items-center gap-3 group text-center">
               <div className="w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm"><Send size={24}/></div>
               <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Enviar</span>
            </button>
            <button onClick={() => setView('addFunds')} className="flex flex-col items-center gap-3 group text-center">
               <div className="w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm"><Plus size={24}/></div>
               <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Ingresar</span>
            </button>
            <button onClick={() => setView('currencies')} className="flex flex-col items-center gap-3 group text-center">
               <div className="w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm"><Globe size={24}/></div>
               <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Divisas</span>
            </button>
         </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div className="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm flex flex-col h-[500px]">
          <h4 className="font-black text-slate-800 text-[11px] uppercase tracking-widest mb-8">Cuentas Cloud</h4>
          <div className="space-y-6 overflow-y-auto flex-1 pr-2 custom-scroll">
             <div className="flex items-center justify-between p-4 bg-indigo-50 rounded-3xl border border-indigo-100">
                <div className="flex items-center gap-4">
                   <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold">$</div>
                   <div><p className="text-sm font-black">Principal</p><p className="text-[10px] font-bold text-indigo-400">USD - Dólar Americano</p></div>
                </div>
                <p className="font-black text-sm">{user?.balance} $</p>
             </div>
             {accounts.map(acc => (
               <div key={acc.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-3xl border border-slate-100 animate-in fade-in">
                  <div className="flex items-center gap-4">
                     <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white font-bold">{acc.symbol}</div>
                     <div><p className="text-sm font-black">{acc.country}</p><p className="text-[10px] font-bold text-slate-400 uppercase">{acc.currency}</p></div>
                  </div>
                  <p className="font-black text-sm">0.00 {acc.symbol}</p>
               </div>
             ))}
          </div>
        </div>

        <div className="bg-white p-10 rounded-[3rem] border border-slate-100 shadow-sm flex flex-col h-[500px]">
          <h4 className="font-black text-slate-800 text-[11px] uppercase tracking-widest mb-8">Historial Cloud</h4>
          <div className="space-y-6 overflow-y-auto flex-1 pr-2 custom-scroll">
            {transactions.length === 0 ? <div className="py-20 text-center opacity-20"><History size={48} className="mx-auto mb-4" /><p className="text-[10px] font-black uppercase">Sin actividad</p></div> : transactions.map(t => (
              <div key={t.id} className="flex items-center justify-between group animate-in slide-in-from-top">
                <div className="flex items-center gap-4">
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center shadow-sm ${t.type === 'income' ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}`}>{t.type === 'income' ? <ArrowDownLeft size={18}/> : <ArrowUpRight size={18}/>}</div>
                  <div><p className="text-xs font-black text-slate-800 tracking-tight">{t.title}</p><p className="text-[8px] text-slate-400 font-bold uppercase tracking-widest">{t.dateLabel}</p></div>
                </div>
                <p className={`font-black text-xs ${t.type === 'income' ? 'text-emerald-600'